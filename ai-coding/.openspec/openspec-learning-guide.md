# OpenSpec å­¦ä¹ æŒ‡å—

> é€‚åˆæŠ€æœ¯åˆ†äº«å’Œå›¢é˜Ÿå­¦ä¹ çš„å®Œæ•´æ•™ç¨‹

## ç›®å½•

1. [ä»€ä¹ˆæ˜¯ OpenSpec](#ä»€ä¹ˆæ˜¯-openspec)
2. [ä¸ºä»€ä¹ˆéœ€è¦ OpenSpec](#ä¸ºä»€ä¹ˆéœ€è¦-openspec)
3. [æ ¸å¿ƒæ¦‚å¿µ](#æ ¸å¿ƒæ¦‚å¿µ)
4. [ç›®å½•ç»“æ„](#ç›®å½•ç»“æ„)
5. [å®Œæ•´å·¥ä½œæµç¨‹](#å®Œæ•´å·¥ä½œæµç¨‹)
6. [å®æˆ˜ç¤ºä¾‹](#å®æˆ˜ç¤ºä¾‹)
7. [å¸¸ç”¨å‘½ä»¤](#å¸¸ç”¨å‘½ä»¤)
8. [æœ€ä½³å®è·µ](#æœ€ä½³å®è·µ)

---

## ä»€ä¹ˆæ˜¯ OpenSpec

**OpenSpec æ˜¯ä¸€ä¸ªè§„èŒƒé©±åŠ¨çš„å¼€å‘æµç¨‹æ¡†æ¶**ï¼Œå¸®åŠ©å›¢é˜Ÿï¼š

- ğŸ“ **ææ¡ˆå…ˆè¡Œ**ï¼šåœ¨å†™ä»£ç å‰å…ˆå†™æ¸…æ¥šè¦åšä»€ä¹ˆ
- ğŸ”„ **å˜æ›´å¯è¿½æº¯**ï¼šæ¯ä¸ªåŠŸèƒ½ä»ææ¡ˆåˆ°å®æ–½åˆ°å½’æ¡£éƒ½æœ‰å®Œæ•´è®°å½•
- âœ… **ä»»åŠ¡å¯éªŒè¯**ï¼šå°†å¤§åŠŸèƒ½æ‹†è§£ä¸ºå¯éªŒè¯çš„å°ä»»åŠ¡
- ğŸ“š **çŸ¥è¯†å¯æ²‰æ·€**ï¼šç³»ç»ŸçœŸç›¸ï¼ˆspecsï¼‰ä¸å†å²è®°å½•ï¼ˆarchiveï¼‰åˆ†ç¦»å­˜å‚¨

**ä¸€å¥è¯æ€»ç»“**ï¼šOpenSpec è®©ä½ çš„é¡¹ç›®å¼€å‘åƒæäº¤ Pull Request ä¸€æ ·è§„èŒƒå’Œå¯è¿½æº¯ã€‚

---

## ä¸ºä»€ä¹ˆéœ€è¦ OpenSpec

### ä¼ ç»Ÿå¼€å‘æµç¨‹çš„ç—›ç‚¹

```
âŒ æ²¡æœ‰ææ¡ˆ â†’ ç›´æ¥å†™ä»£ç  â†’ åŠŸèƒ½è®¾è®¡ä¸æ¸…æ™°
âŒ éœ€æ±‚å£å¤´æ²Ÿé€š â†’ å®¹æ˜“é—æ¼å’Œè¯¯è§£
âŒ ä»»åŠ¡ä¸æ˜ç¡® â†’ ä¸çŸ¥é“è¿›åº¦åˆ°å“ªé‡Œäº†
âŒ æ–‡æ¡£å’Œä»£ç è„±èŠ‚ â†’ æ–‡æ¡£è¿‡æ—¶æ— äººç»´æŠ¤
```

### OpenSpec çš„è§£å†³æ–¹æ¡ˆ

```
âœ… Proposalï¼ˆææ¡ˆï¼‰ â†’ æ˜ç¡® Why/What/Impact
âœ… Designï¼ˆè®¾è®¡ï¼‰ â†’ æŠ€æœ¯æ–¹æ¡ˆå’Œæ¶æ„å†³ç­–
âœ… Tasksï¼ˆä»»åŠ¡ï¼‰ â†’ å¯æ‰§è¡Œçš„ä»»åŠ¡æ¸…å•
âœ… Specsï¼ˆè§„èŒƒï¼‰ â†’ ç³»ç»ŸåŠŸèƒ½çš„å®Œæ•´éœ€æ±‚
âœ… Archiveï¼ˆå½’æ¡£ï¼‰ â†’ å†å²å˜æ›´çš„å®Œæ•´è®°å½•
```

---

## æ ¸å¿ƒæ¦‚å¿µ

### 1. ä¸‰ä¸ªæ ¸å¿ƒç›®å½•

OpenSpec ä½¿ç”¨ä¸‰ä¸ªç›®å½•æ¥ç»„ç»‡é¡¹ç›®æ–‡æ¡£ï¼š

| ç›®å½• | å«ä¹‰ | ç”¨é€” | ç±»æ¯” |
|------|------|------|------|
| **`changes/`** | å·¥ä½œåŒº | æ­£åœ¨è¿›è¡Œçš„å˜æ›´ | ğŸ“ ä½ çš„å·¥ä½œå° |
| **`specs/`** | çœŸç›¸æº | ç³»ç»Ÿå½“å‰çš„å®Œæ•´è§„èŒƒ | âœ… é¡¹ç›®çš„"çœŸç›¸" |
| **`archive/`** | å†å²åº“ | å·²å®Œæˆå˜æ›´çš„å†å²è®°å½• | ğŸ“š é¡¹ç›®çš„"æ—¥è®°æœ¬" |

#### å½¢è±¡ç†è§£

```
changes/  = "æˆ‘æ­£åœ¨åšä»€ä¹ˆï¼Ÿ"     ï¼ˆå·¥ä½œè¿›è¡Œæ—¶ï¼‰
specs/    = "ç³»ç»Ÿç°åœ¨æ˜¯ä»€ä¹ˆæ ·ï¼Ÿ"  ï¼ˆå½“å‰çŠ¶æ€ï¼‰
archive/  = "æˆ‘ä»¬åšè¿‡ä»€ä¹ˆï¼Ÿ"      ï¼ˆå†å²è®°å½•ï¼‰
```

### 2. ä¸¤ç§ Spec æ–‡ä»¶

è¿™æ˜¯ OpenSpec æœ€å®¹æ˜“æ··æ·†çš„åœ°æ–¹ï¼

#### Delta Specï¼ˆå¢é‡è§„èŒƒï¼‰

**ä½ç½®**ï¼š`changes/[change-id]/specs/[capability]/spec.md`

**ç‰¹ç‚¹**ï¼šåŒ…å« `ADDED`ã€`MODIFIED`ã€`REMOVED` æ ‡è®°

**ç”¨é€”**ï¼šæè¿°"è¿™æ¬¡å˜æ›´"è¦æ”¹ä»€ä¹ˆ

```markdown
## ADDED Requirements

### Requirement: HTTP API Server
The system SHALL provide an HTTP API server...

## MODIFIED Requirements

### Requirement: Session Tracking
The system SHALL track up to 100k sessions (previously 50k)...

## REMOVED Requirements

### Requirement: Old Feature
**Reason**: Deprecated
```

#### Complete Specï¼ˆå®Œæ•´è§„èŒƒï¼‰

**ä½ç½®**ï¼š`specs/[capability]/spec.md`

**ç‰¹ç‚¹**ï¼šæ—  `ADDED`/`MODIFIED` æ ‡è®°ï¼Œçº¯å‡€çš„åŠŸèƒ½è§„èŒƒ

**ç”¨é€”**ï¼šæè¿°"ç³»ç»Ÿå½“å‰"æœ‰ä»€ä¹ˆåŠŸèƒ½

```markdown
# Capability: HTTP API

### Requirement: HTTP API Server
The system SHALL provide an HTTP API server...

### Requirement: Session Tracking
The system SHALL track up to 100k sessions...
```

**é‡è¦**ï¼šComplete Spec æ˜¯é€šè¿‡ `archive` å‘½ä»¤è‡ªåŠ¨ä» Delta Spec åˆå¹¶ç”Ÿæˆçš„ï¼

### 3. å››ä¸ªæ ¸å¿ƒæ–‡ä»¶

æ¯ä¸ªå˜æ›´ï¼ˆchangeï¼‰åŒ…å«å››ä¸ªæ–‡ä»¶ï¼š

| æ–‡ä»¶ | ä½œç”¨ | å›ç­”çš„é—®é¢˜ |
|------|------|-----------|
| **`proposal.md`** | ææ¡ˆ | ä¸ºä»€ä¹ˆåšï¼Ÿåšä»€ä¹ˆï¼Ÿå½±å“æ˜¯ä»€ä¹ˆï¼Ÿ |
| **`design.md`** | è®¾è®¡ | æ€ä¹ˆåšï¼ŸæŠ€æœ¯æ–¹æ¡ˆæ˜¯ä»€ä¹ˆï¼Ÿ |
| **`tasks.md`** | ä»»åŠ¡æ¸…å• | å…·ä½“è¦åšå“ªäº›äº‹ï¼Ÿè¿›åº¦å¦‚ä½•ï¼Ÿ |
| **`specs/*/spec.md`** | è§„èŒƒå¢é‡ | åŠŸèƒ½éœ€æ±‚æ˜¯ä»€ä¹ˆï¼Ÿå¦‚ä½•éªŒè¯ï¼Ÿ |

---

## ç›®å½•ç»“æ„

### å®Œæ•´çš„ç›®å½•æ ‘

```
project-root/
â”œâ”€â”€ openspec/
â”‚   â”œâ”€â”€ project.md                    # é¡¹ç›®å…ƒä¿¡æ¯
â”‚   â”œâ”€â”€ AGENTS.md                     # AI åŠ©æ‰‹æŒ‡å—
â”‚   â”‚
â”‚   â”œâ”€â”€ changes/                      # ğŸ“ å·¥ä½œåŒº
â”‚   â”‚   â”œâ”€â”€ add-control-plane-api/    # æ­£åœ¨è¿›è¡Œçš„å˜æ›´
â”‚   â”‚   â”‚   â”œâ”€â”€ proposal.md           # ææ¡ˆæ–‡æ¡£
â”‚   â”‚   â”‚   â”œâ”€â”€ design.md             # è®¾è®¡æ–‡æ¡£
â”‚   â”‚   â”‚   â”œâ”€â”€ tasks.md              # ä»»åŠ¡æ¸…å•
â”‚   â”‚   â”‚   â””â”€â”€ specs/                # è§„èŒƒå¢é‡ï¼ˆDeltaï¼‰
â”‚   â”‚   â”‚       â”œâ”€â”€ control-plane-api/
â”‚   â”‚   â”‚       â”‚   â””â”€â”€ spec.md       # ADDED/MODIFIED éœ€æ±‚
â”‚   â”‚   â”‚       â””â”€â”€ policy-management/
â”‚   â”‚   â”‚           â””â”€â”€ spec.md
â”‚   â”‚   â”‚
â”‚   â”‚   â””â”€â”€ archive/                  # ğŸ“š å†å²åº“
â”‚   â”‚       â”œâ”€â”€ 2025-10-30-implement-session-tracking/
â”‚   â”‚       â”‚   â”œâ”€â”€ proposal.md       # å·²å®Œæˆçš„ææ¡ˆ
â”‚   â”‚       â”‚   â””â”€â”€ tasks.md          # å…¨éƒ¨ [x] å®Œæˆ
â”‚   â”‚       â”œâ”€â”€ 2025-10-30-implement-policy-matching/
â”‚   â”‚       â””â”€â”€ README.md             # å½’æ¡£æ€»ç»“
â”‚   â”‚
â”‚   â””â”€â”€ specs/                        # âœ… çœŸç›¸æºï¼ˆå®Œæ•´è§„èŒƒï¼‰
â”‚       â”œâ”€â”€ session-tracking/
â”‚       â”‚   â””â”€â”€ spec.md               # çº¯å‡€çš„å®Œæ•´è§„èŒƒ
â”‚       â”œâ”€â”€ policy-matching/
â”‚       â”‚   â””â”€â”€ spec.md
â”‚       â””â”€â”€ control-plane-api/
â”‚           â””â”€â”€ spec.md               # archive åè‡ªåŠ¨ç”Ÿæˆ
â”‚
â””â”€â”€ src/                              # å®é™…ä»£ç 
    â””â”€â”€ ...
```

### ç›®å½•æ¼”å˜è¿‡ç¨‹

```
é˜¶æ®µ 1: Proposalï¼ˆææ¡ˆï¼‰
changes/add-api/
â”œâ”€â”€ proposal.md     â† åˆ›å»º
â”œâ”€â”€ design.md       â† åˆ›å»º
â”œâ”€â”€ tasks.md        â† åˆ›å»º
â””â”€â”€ specs/api/
    â””â”€â”€ spec.md     â† åˆ›å»ºï¼ˆDeltaï¼Œæœ‰ ADDED æ ‡è®°ï¼‰

é˜¶æ®µ 2: Applyï¼ˆå®æ–½ï¼‰
changes/add-api/
â”œâ”€â”€ proposal.md     â† ä¸å˜
â”œâ”€â”€ design.md       â† ä¸å˜
â”œâ”€â”€ tasks.md        â† æ›´æ–°è¿›åº¦ [ ] â†’ [x]
â””â”€â”€ specs/api/
    â””â”€â”€ spec.md     â† ä¸å˜

é˜¶æ®µ 3: Archiveï¼ˆå½’æ¡£ï¼‰
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ç§»åŠ¨æ–‡æ¡£åˆ° archive/                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
archive/2025-10-30-add-api/
â”œâ”€â”€ proposal.md     â† ç§»åŠ¨åˆ°è¿™é‡Œ
â”œâ”€â”€ design.md       â† ç§»åŠ¨åˆ°è¿™é‡Œ
â””â”€â”€ tasks.md        â† ç§»åŠ¨åˆ°è¿™é‡Œï¼ˆå…¨éƒ¨å®Œæˆï¼‰

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ åˆå¹¶å¢é‡åˆ° specs/                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
specs/api/
â””â”€â”€ spec.md         â† æ–°å»ºï¼ˆCompleteï¼Œæ—  ADDED æ ‡è®°ï¼‰

changes/add-api/    â† åˆ é™¤æ•´ä¸ªç›®å½•
```

---

## å®Œæ•´å·¥ä½œæµç¨‹

### ä¸‰é˜¶æ®µæµç¨‹å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   PROPOSAL   â”‚ â”€â”€â”€> â”‚     APPLY    â”‚ â”€â”€â”€> â”‚   ARCHIVE    â”‚
â”‚   (ææ¡ˆ)     â”‚      â”‚    (å®æ–½)     â”‚      â”‚   (å½’æ¡£)     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
   åˆ›å»ºæ–‡æ¡£              ç¼–å†™ä»£ç               åˆå¹¶è§„èŒƒ
   å®šä¹‰éœ€æ±‚              æ›´æ–°ä»»åŠ¡              ç§»åŠ¨åˆ°å†å²
```

### é˜¶æ®µ 1: PROPOSALï¼ˆææ¡ˆï¼‰

#### ç›®æ ‡

åˆ›å»ºå˜æ›´ææ¡ˆï¼Œæ˜ç¡®è¦åšä»€ä¹ˆã€ä¸ºä»€ä¹ˆåšã€æ€ä¹ˆåšã€‚

#### æ“ä½œ

```bash
# æ–¹å¼ 1: ä½¿ç”¨ OpenSpec å‘½ä»¤ï¼ˆæ¨èï¼‰
/openspec:proposal add-control-plane-api

# æ–¹å¼ 2: æ‰‹åŠ¨åˆ›å»ºç›®å½•å’Œæ–‡ä»¶
mkdir -p openspec/changes/add-control-plane-api/specs
cd openspec/changes/add-control-plane-api
touch proposal.md design.md tasks.md
```

#### åˆ›å»ºçš„æ–‡ä»¶

**1. proposal.md** - ææ¡ˆæ–‡æ¡£

```markdown
# Proposal: Add Control Plane API

## Whyï¼ˆä¸ºä»€ä¹ˆï¼‰
- éœ€è¦æä¾› REST API è®©å¤–éƒ¨ç³»ç»Ÿç®¡ç†ç­–ç•¥
- å½“å‰åªèƒ½é€šè¿‡å‘½ä»¤è¡Œæ“ä½œï¼Œä¸ä¾¿äºè‡ªåŠ¨åŒ–

## Whatï¼ˆåšä»€ä¹ˆï¼‰
- å®ç° HTTP API æœåŠ¡å™¨ï¼ˆGin æ¡†æ¶ï¼‰
- æä¾›ç­–ç•¥ CRUD ç«¯ç‚¹
- æä¾›ç»Ÿè®¡æŸ¥è¯¢ç«¯ç‚¹
- æä¾›å¥åº·æ£€æŸ¥ç«¯ç‚¹

## Impactï¼ˆå½±å“ï¼‰
- æ–°å¢ API æœåŠ¡å™¨ç»„ä»¶ï¼ˆ~3000 è¡Œä»£ç ï¼‰
- éœ€è¦æ–°å¢é…ç½®é¡¹ï¼šAPI_PORT, API_ENABLE
- å¯¹ç°æœ‰æ•°æ®å¹³é¢æ— å½±å“ï¼ˆåªè¯»è®¿é—®ï¼‰

## Timeline
- é¢„è®¡æ—¶é—´ï¼š3 å‘¨
- é‡Œç¨‹ç¢‘ï¼š
  - Week 1: API æ¡†æ¶å’ŒåŸºç¡€ç«¯ç‚¹
  - Week 2: ç­–ç•¥ç®¡ç†ç«¯ç‚¹
  - Week 3: æµ‹è¯•å’Œæ–‡æ¡£

## Risks
- API å¹¶å‘æ€§èƒ½éœ€è¦å‹æµ‹
- éœ€è¦è€ƒè™‘è®¤è¯æˆæƒï¼ˆåç»­åŠŸèƒ½ï¼‰
```

**2. design.md** - è®¾è®¡æ–‡æ¡£

```markdown
# Design: Control Plane API

## Architecture

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  REST API   â”‚  â† æ–°å¢ç»„ä»¶
â”‚  (Gin)      â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â”œâ”€> Policy Manager  â† ç°æœ‰ç»„ä»¶
       â”œâ”€> Stats Collector â† ç°æœ‰ç»„ä»¶
       â””â”€> Config Manager  â† ç°æœ‰ç»„ä»¶

## Technical Decisions

### 1. Web æ¡†æ¶é€‰æ‹©
- **é€‰æ‹©**ï¼šGin
- **åŸå› **ï¼šè½»é‡ã€æ€§èƒ½å¥½ã€ç¤¾åŒºæ´»è·ƒ
- **å¤‡é€‰**ï¼šEchoã€Chi

### 2. å¹¶å‘æ§åˆ¶
- **é€‰æ‹©**ï¼šsync.RWMutex
- **åŸå› **ï¼šè¯»å¤šå†™å°‘åœºæ™¯
- **è€ƒè™‘**ï¼šæœªæ¥å¯å‡çº§åˆ° sync.Map

### 3. API ç‰ˆæœ¬åŒ–
- **é€‰æ‹©**ï¼šURL è·¯å¾„ç‰ˆæœ¬åŒ– (/api/v1/...)
- **åŸå› **ï¼šç®€å•æ˜ç¡®ï¼Œæ˜“äºè·¯ç”±
- **å¤‡é€‰**ï¼šHeader ç‰ˆæœ¬åŒ–

## API Design

### ç­–ç•¥ç®¡ç†
- POST   /api/v1/policies      # åˆ›å»ºç­–ç•¥
- GET    /api/v1/policies      # åˆ—å‡ºç­–ç•¥
- GET    /api/v1/policies/:id  # è·å–ç­–ç•¥
- PUT    /api/v1/policies/:id  # æ›´æ–°ç­–ç•¥
- DELETE /api/v1/policies/:id  # åˆ é™¤ç­–ç•¥

### ç»Ÿè®¡æŸ¥è¯¢
- GET /api/v1/stats            # æ€»ä½“ç»Ÿè®¡
- GET /api/v1/stats/packets    # æ•°æ®åŒ…ç»Ÿè®¡
- GET /api/v1/stats/sessions   # ä¼šè¯ç»Ÿè®¡

## Performance Goals
- API å“åº”å»¶è¿Ÿ: < 10ms
- å¹¶å‘å¤„ç†: 1000 req/s
- æ•°æ®å¹³é¢å½±å“: < 1% CPU
```

**3. tasks.md** - ä»»åŠ¡æ¸…å•

```markdown
# Tasks: Add Control Plane API

## Phase 1: Framework Setup
- [ ] Install Gin framework
- [ ] Create API server structure
- [ ] Add configuration loading
- [ ] Implement graceful shutdown

## Phase 2: Core Endpoints
- [ ] Implement health check endpoint
- [ ] Implement status endpoint
- [ ] Add middleware (logging, CORS)
- [ ] Add error handling

## Phase 3: Policy Management
- [ ] Implement POST /policies
- [ ] Implement GET /policies
- [ ] Implement GET /policies/:id
- [ ] Implement PUT /policies/:id
- [ ] Implement DELETE /policies/:id
- [ ] Add input validation
- [ ] Add policy syntax checking

## Phase 4: Stats Endpoints
- [ ] Implement GET /stats
- [ ] Implement GET /stats/packets
- [ ] Implement GET /stats/sessions
- [ ] Add stats caching

## Phase 5: Testing
- [ ] Unit tests for handlers
- [ ] Integration tests for API
- [ ] Performance tests
- [ ] Load tests (1000 req/s)

## Phase 6: Documentation
- [ ] API documentation (OpenAPI/Swagger)
- [ ] Usage examples
- [ ] Configuration guide
```

**4. specs/control-plane-api/spec.md** - è§„èŒƒå¢é‡

```markdown
# Capability: Control Plane API

## ADDED Requirements

### Requirement: HTTP API Server
The system SHALL provide an HTTP API server that:
- Listens on a configurable port (default 8080)
- Uses the Gin web framework
- Supports graceful shutdown
- Logs all API requests

#### Scenario: API server starts successfully
- GIVEN the API is enabled in configuration
- WHEN the agent starts
- THEN the HTTP server MUST listen on the configured port
- AND log "API server started on :8080"

#### Scenario: API server handles concurrent requests
- GIVEN the API server is running
- WHEN 100 concurrent requests are sent
- THEN all requests MUST complete within 1 second
- AND no request MUST fail

### Requirement: Policy Management Endpoints
The API SHALL provide RESTful endpoints for policy management:
- POST /api/v1/policies - Create policy
- GET /api/v1/policies - List policies
- GET /api/v1/policies/:id - Get policy
- PUT /api/v1/policies/:id - Update policy
- DELETE /api/v1/policies/:id - Delete policy

#### Scenario: Create policy via API
- GIVEN a valid policy JSON payload
- WHEN POST /api/v1/policies is called
- THEN return 201 Created
- AND return the created policy with ID
- AND the policy MUST be applied to the data plane

#### Scenario: Invalid policy rejected
- GIVEN an invalid policy JSON
- WHEN POST /api/v1/policies is called
- THEN return 400 Bad Request
- AND return error details
- AND no policy MUST be created

### Requirement: Health Check
The API SHALL provide a health check endpoint:
- GET /api/v1/health

#### Scenario: Health check returns OK
- WHEN GET /api/v1/health is called
- THEN return 200 OK
- AND return {"status": "ok", "uptime": <seconds>}
```

#### éªŒè¯ææ¡ˆ

```bash
# éªŒè¯ææ¡ˆæ ¼å¼å’Œå®Œæ•´æ€§
openspec validate add-control-plane-api --strict

# æŸ¥çœ‹æ´»åŠ¨å˜æ›´åˆ—è¡¨
openspec list

# è¾“å‡ºç¤ºä¾‹ï¼š
# add-control-plane-api  0/25 tasks  (proposed)
```

---

### é˜¶æ®µ 2: APPLYï¼ˆå®æ–½ï¼‰

#### ç›®æ ‡

æŒ‰ç…§ tasks.md é€é¡¹å®æ–½åŠŸèƒ½ï¼Œæ›´æ–°ä»»åŠ¡å®ŒæˆçŠ¶æ€ã€‚

#### æ“ä½œ

```bash
# æ–¹å¼ 1: ä½¿ç”¨ OpenSpec å‘½ä»¤
/openspec:apply add-control-plane-api

# æ–¹å¼ 2: æ‰‹åŠ¨å®æ–½
# 1. æŸ¥çœ‹ä»»åŠ¡æ¸…å•
cat openspec/changes/add-control-plane-api/tasks.md

# 2. ç¼–å†™ä»£ç 
vim src/agent/api/server.go

# 3. æ›´æ–°ä»»åŠ¡çŠ¶æ€
# å°† [ ] æ”¹ä¸º [x]
```

#### å®æ–½è¿‡ç¨‹

```markdown
# tasks.md çš„å˜åŒ–

åˆå§‹çŠ¶æ€ï¼ˆ0/25ï¼‰:
- [ ] Install Gin framework
- [ ] Create API server structure
- [ ] Add configuration loading

å®æ–½ä¸­ï¼ˆ12/25ï¼‰:
- [x] Install Gin framework          â† å·²å®Œæˆ
- [x] Create API server structure    â† å·²å®Œæˆ
- [x] Add configuration loading      â† å·²å®Œæˆ
- [ ] Implement graceful shutdown
- [ ] Implement health check endpoint

å…¨éƒ¨å®Œæˆï¼ˆ25/25ï¼‰:
- [x] Install Gin framework
- [x] Create API server structure
- [x] Add configuration loading
- [x] Implement graceful shutdown
- [x] Implement health check endpoint
... (æ‰€æœ‰ä»»åŠ¡éƒ½æ˜¯ [x])
```

#### æŸ¥çœ‹è¿›åº¦

```bash
# æŸ¥çœ‹è¿›åº¦
openspec list

# è¾“å‡ºç¤ºä¾‹ï¼š
# add-control-plane-api  12/25 tasks  (in progress)
#                        â†‘
#                        è¿›åº¦å®æ—¶æ›´æ–°
```

#### ä»£ç å®ç°ç¤ºä¾‹

```go
// src/agent/api/server.go
package api

import (
    "github.com/gin-gonic/gin"
    "net/http"
)

type Server struct {
    router *gin.Engine
    port   string
}

func NewServer(port string) *Server {
    r := gin.Default()

    // Health check endpoint
    r.GET("/api/v1/health", func(c *gin.Context) {
        c.JSON(http.StatusOK, gin.H{
            "status": "ok",
            "uptime": getUptime(),
        })
    })

    // Policy endpoints
    r.POST("/api/v1/policies", createPolicy)
    r.GET("/api/v1/policies", listPolicies)
    r.GET("/api/v1/policies/:id", getPolicy)
    r.PUT("/api/v1/policies/:id", updatePolicy)
    r.DELETE("/api/v1/policies/:id", deletePolicy)

    return &Server{router: r, port: port}
}

func (s *Server) Start() error {
    return s.router.Run(s.port)
}
```

---

### é˜¶æ®µ 3: ARCHIVEï¼ˆå½’æ¡£ï¼‰

#### ç›®æ ‡

åŠŸèƒ½å¼€å‘å®Œæˆåï¼Œå°†å˜æ›´å½’æ¡£å¹¶åˆå¹¶è§„èŒƒåˆ°ç³»ç»ŸçœŸç›¸ã€‚

#### å‰ææ¡ä»¶

- âœ… tasks.md ä¸­æ‰€æœ‰ä»»åŠ¡éƒ½æ ‡è®°ä¸ºå®Œæˆ `[x]`
- âœ… ä»£ç å·²æäº¤
- âœ… æµ‹è¯•å·²é€šè¿‡

#### æ“ä½œ

```bash
# æ–¹å¼ 1: ä½¿ç”¨ OpenSpec å‘½ä»¤
/openspec:archive add-control-plane-api --yes

# æ–¹å¼ 2: æ‰‹åŠ¨å½’æ¡£
openspec archive add-control-plane-api --yes
```

#### Archive åšäº†ä»€ä¹ˆ

**æ“ä½œ A: ç§»åŠ¨æ–‡æ¡£åˆ° archive/**

```
ä¹‹å‰ï¼š
changes/add-control-plane-api/
â”œâ”€â”€ proposal.md
â”œâ”€â”€ design.md
â””â”€â”€ tasks.md

ä¹‹åï¼š
archive/2025-10-30-add-control-plane-api/
â”œâ”€â”€ proposal.md    â† ç§»åŠ¨åˆ°è¿™é‡Œ
â”œâ”€â”€ design.md      â† ç§»åŠ¨åˆ°è¿™é‡Œ
â””â”€â”€ tasks.md       â† ç§»åŠ¨åˆ°è¿™é‡Œ
```

**æ“ä½œ B: åˆå¹¶ Delta Spec åˆ° Complete Spec**

```
ä¹‹å‰ï¼ˆDelta Specï¼‰:
changes/add-control-plane-api/specs/control-plane-api/spec.md
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ## ADDED Requirements                  â”‚
â”‚                                        â”‚
â”‚ ### Requirement: HTTP API Server      â”‚
â”‚ The system SHALL...                   â”‚
â”‚                                        â”‚
â”‚ ### Requirement: Policy Endpoints     â”‚
â”‚ The API SHALL...                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ä¹‹åï¼ˆComplete Specï¼‰:
specs/control-plane-api/spec.md
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ # Capability: Control Plane API       â”‚
â”‚                                        â”‚
â”‚ ### Requirement: HTTP API Server      â”‚  â† æ—  ADDED æ ‡è®°
â”‚ The system SHALL...                   â”‚
â”‚                                        â”‚
â”‚ ### Requirement: Policy Endpoints     â”‚
â”‚ The API SHALL...                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**æ“ä½œ C: åˆ é™¤ changes/ ä¸­çš„å˜æ›´ç›®å½•**

```
changes/add-control-plane-api/  â† æ•´ä¸ªç›®å½•è¢«åˆ é™¤
```

#### å½’æ¡£åçš„çŠ¶æ€

```bash
# æŸ¥çœ‹æ´»åŠ¨å˜æ›´ï¼ˆåº”è¯¥ä¸ºç©ºï¼‰
openspec list
# è¾“å‡º: No active changes found.

# æŸ¥çœ‹å®Œæ•´è§„èŒƒ
openspec list --specs
# è¾“å‡º:
# control-plane-api    â† æ–°å¢çš„å®Œæ•´è§„èŒƒ
# session-tracking
# policy-matching

# æŸ¥çœ‹å½’æ¡£å†å²
ls -la openspec/changes/archive/
# è¾“å‡º:
# 2025-10-30-add-control-plane-api/
# 2025-10-29-implement-session-tracking/
# ...
```

---

## å®æˆ˜ç¤ºä¾‹

### ç¤ºä¾‹ 1: æ·»åŠ æ–°åŠŸèƒ½ï¼ˆä»é›¶å¼€å§‹ï¼‰

**åœºæ™¯**ï¼šä¸ºç³»ç»Ÿæ·»åŠ  FQDNï¼ˆåŸŸåï¼‰è¿‡æ»¤åŠŸèƒ½

#### Step 1: åˆ›å»ºææ¡ˆ

```bash
# ä½¿ç”¨æ–œæ å‘½ä»¤åˆ›å»ºææ¡ˆ
/openspec:proposal add-fqdn-filtering
```

åˆ›å»ºçš„æ–‡ä»¶ç»“æ„ï¼š

```
openspec/changes/add-fqdn-filtering/
â”œâ”€â”€ proposal.md
â”œâ”€â”€ design.md
â”œâ”€â”€ tasks.md
â””â”€â”€ specs/
    â””â”€â”€ fqdn-filtering/
        â””â”€â”€ spec.md
```

#### Step 2: ç¼–å†™ææ¡ˆå†…å®¹

**proposal.md**:

```markdown
# Proposal: Add FQDN Filtering

## Why
- ç”¨æˆ·éœ€è¦åŸºäºåŸŸåï¼ˆè€Œé IPï¼‰è¿›è¡Œè®¿é—®æ§åˆ¶
- æ”¯æŒ *.example.com é€šé…ç¬¦åŒ¹é…
- è§£å†³åŠ¨æ€ IP åœºæ™¯ï¼ˆå¦‚ CDNï¼‰

## What
- å®ç° FQDN æ˜ å°„è¡¨ï¼ˆåŸŸå â†’ IPï¼‰
- DNS æ‹¦æˆªå’Œå­¦ä¹ 
- ç­–ç•¥è§„åˆ™æ”¯æŒ FQDN å­—æ®µ

## Impact
- æ–°å¢ FQDN åŒ¹é…æ¨¡å—ï¼ˆ~2000 è¡Œä»£ç ï¼‰
- éœ€è¦æ‹¦æˆª DNS æµé‡
- å†…å­˜å ç”¨å¢åŠ ï¼ˆä¼°è®¡ 10MBï¼Œ10k åŸŸåï¼‰
```

**design.md**:

```markdown
# Design: FQDN Filtering

## Data Structure

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  FQDN Map          â”‚
â”‚  (RCU Hash Table)  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚
    â”Œâ”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”
    â”‚           â”‚
â”Œâ”€â”€â”€â–¼â”€â”€â”€â”   â”Œâ”€â”€â”€â–¼â”€â”€â”€â”
â”‚Domain â”‚   â”‚  IP   â”‚
â”‚â†’ IP   â”‚   â”‚â†’ FQDN â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”˜

## DNS Interception
- Hook DNS responses (port 53)
- Extract A/AAAA records
- Update FQDN â†’ IP mapping

## Policy Matching
1. Extract dst_ip from packet
2. Lookup IP â†’ FQDN mapping
3. Match FQDN against policy rules
4. Apply action (ALLOW/DENY)
```

**tasks.md**:

```markdown
# Tasks: Add FQDN Filtering

- [ ] Define FQDN data structures
- [ ] Implement FQDN hash table (RCU)
- [ ] Add DNS parser
- [ ] Hook DNS response packets
- [ ] Implement FQDN â†’ IP learning
- [ ] Support wildcard matching (*.example.com)
- [ ] Update policy matching logic
- [ ] Add FQDN field to policy API
- [ ] Unit tests for FQDN matching
- [ ] Integration tests
- [ ] Performance tests (10k domains)
- [ ] Documentation
```

#### Step 3: éªŒè¯ææ¡ˆ

```bash
openspec validate add-fqdn-filtering --strict

# è¾“å‡º:
# âœ… proposal.md found
# âœ… design.md found
# âœ… tasks.md found
# âœ… specs/ directory found
# âœ… All tasks follow format
# Validation passed!
```

#### Step 4: å®æ–½åŠŸèƒ½

```bash
/openspec:apply add-fqdn-filtering
```

ç¼–å†™ä»£ç å¹¶æ›´æ–°ä»»åŠ¡ï¼š

```bash
# 1. å®ç° FQDN æ•°æ®ç»“æ„
vim src/ebpf/fqdn.h
# å®Œæˆåæ›´æ–° tasks.md: [x] Define FQDN data structures

# 2. å®ç° DNS è§£æ
vim src/ebpf/dns_parser.c
# å®Œæˆåæ›´æ–° tasks.md: [x] Add DNS parser

# ... ä¾æ¬¡å®Œæˆæ‰€æœ‰ä»»åŠ¡
```

#### Step 5: å½’æ¡£å˜æ›´

æ‰€æœ‰ä»»åŠ¡å®Œæˆåï¼š

```bash
/openspec:archive add-fqdn-filtering --yes

# ç»“æœ:
# âœ… Moved to archive/2025-10-30-add-fqdn-filtering/
# âœ… Merged to specs/fqdn-filtering/spec.md
# âœ… Removed from changes/
```

---

### ç¤ºä¾‹ 2: ä¿®æ”¹å·²æœ‰åŠŸèƒ½

**åœºæ™¯**ï¼šä¼˜åŒ–ä¼šè¯è·Ÿè¸ªæ€§èƒ½ï¼ˆåŠŸèƒ½å·²å­˜åœ¨äº specs/ï¼‰

#### Step 1: åˆ›å»ºä¼˜åŒ–ææ¡ˆ

```bash
/openspec:proposal optimize-session-tracking
```

#### Step 2: ç¼–å†™å¢é‡è§„èŒƒ

**specs/session-tracking/spec.md** (Delta):

```markdown
# Capability: Session Tracking

## MODIFIED Requirements

### Requirement: Session Storage
The system SHALL store up to **200k** sessions (previously 100k)
using LRU_HASH map...

**Changes**:
- Increase capacity: 100k â†’ 200k
- Add per-CPU statistics
- Optimize lookup path

## ADDED Requirements

### Requirement: Session Metrics Export
The system SHALL export session metrics via Ring Buffer:
- Total sessions count
- Active sessions per protocol (TCP/UDP/ICMP)
- Session creation/deletion rate

#### Scenario: Export metrics every 10 seconds
- GIVEN the system is running
- WHEN 10 seconds elapsed
- THEN session metrics MUST be exported to ring buffer
- AND user space MUST receive the metrics

## REMOVED Requirements

### Requirement: Session Cleanup Timer
**Reason**: Replaced by LRU automatic eviction
**Migration**: No manual cleanup needed
```

#### Step 3: å®æ–½ä¼˜åŒ–

```bash
/openspec:apply optimize-session-tracking

# ä¿®æ”¹ä»£ç 
vim src/ebpf/session.h    # å¢åŠ  map å®¹é‡
vim src/ebpf/session.c    # æ·»åŠ æŒ‡æ ‡å¯¼å‡º
vim src/ebpf/stats.c      # å®ç° ring buffer

# æ›´æ–°ä»»åŠ¡
vim openspec/changes/optimize-session-tracking/tasks.md
```

#### Step 4: å½’æ¡£å¹¶åˆå¹¶

```bash
/openspec:archive optimize-session-tracking --yes
```

**å½’æ¡£åï¼Œspecs/session-tracking/spec.md å˜æˆ**:

```markdown
# Capability: Session Tracking

### Requirement: Session Storage
The system SHALL store up to 200k sessions       â† å·²æ›´æ–°
using LRU_HASH map...

### Requirement: Session Metrics Export          â† å·²æ·»åŠ 
The system SHALL export session metrics...

(Session Cleanup Timer å·²åˆ é™¤)                  â† å·²ç§»é™¤
```

---

### ç¤ºä¾‹ 3: å›é¡¾æ€§å½’æ¡£ï¼ˆå·²å®Œæˆçš„åŠŸèƒ½ï¼‰

**åœºæ™¯**ï¼šä½ å·²ç»å®ç°äº† 5 ä¸ªåŠŸèƒ½ï¼Œä½†æ²¡æœ‰ä½¿ç”¨ OpenSpecï¼Œç°åœ¨æƒ³è¡¥å……æ–‡æ¡£ã€‚

#### Step 1: ä¸ºæ¯ä¸ªåŠŸèƒ½åˆ›å»ºææ¡ˆï¼ˆå›é¡¾æ€§ï¼‰

```bash
# åˆ›å»ºå·²å®ŒæˆåŠŸèƒ½çš„ææ¡ˆ
mkdir -p openspec/changes/archive

# åŠŸèƒ½ 1: ä¼šè¯è·Ÿè¸ª
mkdir -p openspec/changes/archive/2025-10-28-implement-session-tracking
cat > openspec/changes/archive/2025-10-28-implement-session-tracking/proposal.md <<EOF
# Proposal: Implement Session Tracking

## Why
éœ€è¦è·Ÿè¸ªç½‘ç»œè¿æ¥çŠ¶æ€

## What
å®ç°åŸºäº eBPF LRU_HASH çš„ä¼šè¯è·Ÿè¸ª

## Impact
- æ”¯æŒ 100k å¹¶å‘ä¼šè¯
- å†…å­˜å ç”¨ ~50MB
EOF

cat > openspec/changes/archive/2025-10-28-implement-session-tracking/tasks.md <<EOF
# Tasks: Implement Session Tracking

- [x] Define session data structure
- [x] Create LRU_HASH map
- [x] Implement session lookup
- [x] Implement session creation
- [x] Implement session timeout
- [x] Add unit tests
- [x] Add integration tests
- [x] Performance testing
EOF
```

#### Step 2: æ‰¹é‡å½’æ¡£

é‡å¤ä¸ºæ‰€æœ‰å·²å®ŒæˆåŠŸèƒ½åˆ›å»ºæ–‡æ¡£ï¼Œç„¶åï¼š

```bash
# æŸ¥çœ‹å½’æ¡£
ls -la openspec/changes/archive/
# è¾“å‡º:
# 2025-10-28-implement-session-tracking/
# 2025-10-29-implement-policy-matching/
# 2025-10-29-implement-policy-enforcement/
# 2025-10-30-implement-stats-reporting/
# 2025-10-30-optimize-dataplane-performance/
```

---

## å¸¸ç”¨å‘½ä»¤

### OpenSpec CLI å‘½ä»¤

```bash
# æŸ¥çœ‹æ´»åŠ¨å˜æ›´
openspec list
# è¾“å‡º: add-api  12/25 tasks  (in progress)

# æŸ¥çœ‹å®Œæ•´è§„èŒƒ
openspec list --specs
# è¾“å‡º: control-plane-api, session-tracking, policy-matching

# éªŒè¯ææ¡ˆ
openspec validate <change-id> --strict

# å½’æ¡£å˜æ›´
openspec archive <change-id> --yes

# æŸ¥çœ‹å¸®åŠ©
openspec --help
```

### æ–œæ å‘½ä»¤ï¼ˆåœ¨æ”¯æŒçš„ç¯å¢ƒä¸­ï¼‰

```bash
# åˆ›å»ºææ¡ˆ
/openspec:proposal <change-id>

# å®æ–½å˜æ›´
/openspec:apply <change-id>

# å½’æ¡£å˜æ›´
/openspec:archive <change-id>
```

### æ‰‹åŠ¨æ“ä½œ

```bash
# åˆ›å»ºå˜æ›´ç›®å½•
mkdir -p openspec/changes/<change-id>/specs

# æŸ¥çœ‹æ´»åŠ¨å˜æ›´
ls -la openspec/changes/

# æŸ¥çœ‹å½’æ¡£å†å²
ls -la openspec/changes/archive/

# æŸ¥çœ‹å®Œæ•´è§„èŒƒ
ls -la openspec/specs/

# éªŒè¯ä»»åŠ¡æ ¼å¼
grep -E '^\- \[(x| )\]' openspec/changes/<change-id>/tasks.md

# ç»Ÿè®¡ä»»åŠ¡è¿›åº¦
grep -c '^\- \[x\]' openspec/changes/<change-id>/tasks.md
grep -c '^\- \[' openspec/changes/<change-id>/tasks.md
```

---

## æœ€ä½³å®è·µ

### 1. å‘½åè§„èŒƒ

#### Change ID å‘½åï¼ˆkebab-caseï¼‰

```bash
âœ… æ¨è:
- add-control-plane-api
- implement-session-tracking
- optimize-dataplane-performance
- fix-memory-leak-in-dns
- update-policy-matching-logic

âŒ é¿å…:
- Add_Control_Plane_API       (ä¸è¦ç”¨ä¸‹åˆ’çº¿)
- addControlPlaneAPI          (ä¸è¦ç”¨é©¼å³°)
- api                         (å¤ªæ¨¡ç³Š)
- feature-123                 (ç”¨æè¿°æ€§åç§°ï¼Œä¸æ˜¯ç¼–å·)
```

#### åŠ¨è¯å‰ç¼€

ä½¿ç”¨æ˜ç¡®çš„åŠ¨è¯å¼€å¤´ï¼š

| åŠ¨è¯ | ç”¨é€” | ç¤ºä¾‹ |
|------|------|------|
| `add-` | æ·»åŠ æ–°åŠŸèƒ½ | add-fqdn-filtering |
| `implement-` | å®ç°æ–°æ¨¡å— | implement-dns-parser |
| `update-` | æ›´æ–°ç°æœ‰åŠŸèƒ½ | update-api-response-format |
| `optimize-` | æ€§èƒ½ä¼˜åŒ– | optimize-packet-processing |
| `fix-` | ä¿®å¤ bug | fix-race-condition-in-stats |
| `refactor-` | é‡æ„ | refactor-policy-engine |
| `remove-` | åˆ é™¤åŠŸèƒ½ | remove-deprecated-api |

### 2. ææ¡ˆç¼–å†™

#### proposal.md ç»“æ„

```markdown
# Proposal: <ç®€çŸ­æ ‡é¢˜>

## Whyï¼ˆä¸ºä»€ä¹ˆï¼‰
- ä¸šåŠ¡éœ€æ±‚
- æŠ€æœ¯ç—›ç‚¹
- ç”¨æˆ·åé¦ˆ

## Whatï¼ˆåšä»€ä¹ˆï¼‰
- åŠŸèƒ½ 1
- åŠŸèƒ½ 2
- åŠŸèƒ½ 3

## Impactï¼ˆå½±å“ï¼‰
- ä»£ç å˜æ›´èŒƒå›´
- æ€§èƒ½å½±å“
- å…¼å®¹æ€§å½±å“
- é…ç½®å˜æ›´

## Timelineï¼ˆæ—¶é—´çº¿ï¼‰
- Week 1: ...
- Week 2: ...

## Risksï¼ˆé£é™©ï¼‰
- é£é™© 1 åŠç¼“è§£æªæ–½
- é£é™© 2 åŠç¼“è§£æªæ–½
```

#### å¥½çš„ Why ç¤ºä¾‹

```markdown
## Why

âœ… å…·ä½“çš„é—®é¢˜ï¼š
- ç”¨æˆ·æ— æ³•é€šè¿‡åŸŸåé…ç½®è®¿é—®æ§åˆ¶è§„åˆ™
- å½“å‰åªæ”¯æŒ IP åœ°å€ï¼Œä½†å¾ˆå¤šæœåŠ¡ä½¿ç”¨åŠ¨æ€ IPï¼ˆCDNï¼‰
- æ¯æ¬¡ IP å˜åŒ–éƒ½éœ€è¦æ‰‹åŠ¨æ›´æ–°è§„åˆ™ï¼Œç”¨æˆ·åé¦ˆä½“éªŒå·®

âŒ æ¨¡ç³Šçš„æè¿°ï¼š
- éœ€è¦æ”¯æŒ FQDN
- ç”¨æˆ·è¦æ±‚
```

### 3. ä»»åŠ¡æ‹†åˆ†

#### ä»»åŠ¡ç²’åº¦

```markdown
âœ… å¥½çš„ä»»åŠ¡ï¼ˆå¯éªŒè¯ã€ç²’åº¦é€‚ä¸­ï¼‰:
- [ ] Define FQDN data structure in fqdn.h
- [ ] Implement FQDN hash table with RCU
- [ ] Add DNS response parser
- [ ] Hook DNS packets in TC egress
- [ ] Unit test for wildcard matching

âŒ ä¸å¥½çš„ä»»åŠ¡ï¼ˆå¤ªå¤§æˆ–å¤ªå°ï¼‰:
- [ ] Implement FQDN feature           (å¤ªå¤§ï¼Œæ— æ³•éªŒè¯)
- [ ] Add comment to code              (å¤ªå°ï¼Œæ²¡å¿…è¦)
- [ ] Fix all bugs                     (ä¸æ˜ç¡®)
```

#### ä»»åŠ¡åˆ†ç»„

```markdown
# Tasks: Add FQDN Filtering

## Phase 1: Data Structure (Week 1)
- [ ] Define fqdn_record_t structure
- [ ] Implement fqdn_map hash table
- [ ] Add RCU synchronization

## Phase 2: DNS Interception (Week 1-2)
- [ ] Implement DNS header parser
- [ ] Extract A/AAAA records
- [ ] Update FQDN â†’ IP mapping

## Phase 3: Policy Integration (Week 2)
- [ ] Add FQDN field to policy struct
- [ ] Update policy matching logic
- [ ] Support wildcard patterns

## Phase 4: Testing (Week 2-3)
- [ ] Unit tests (10 test cases)
- [ ] Integration tests (5 scenarios)
- [ ] Performance tests (10k FQDNs)
- [ ] Load tests (1M packets/s)

## Phase 5: Documentation (Week 3)
- [ ] API documentation
- [ ] Configuration guide
- [ ] Performance tuning guide
```

### 4. è§„èŒƒç¼–å†™

#### Requirement æ ¼å¼

```markdown
### Requirement: <ç®€çŸ­æ ‡é¢˜>
<è¯¦ç»†æè¿°ï¼Œä½¿ç”¨ SHALL/MUST/SHOULD>

#### Scenario: <åœºæ™¯åç§°>
- GIVEN <å‰ç½®æ¡ä»¶>
- WHEN <è§¦å‘åŠ¨ä½œ>
- THEN <é¢„æœŸç»“æœ>
- AND <é¢å¤–éªŒè¯>

#### Scenario: <å¦ä¸€ä¸ªåœºæ™¯>
...
```

#### ç¤ºä¾‹

```markdown
### Requirement: FQDN Wildcard Matching
The system SHALL support wildcard FQDN patterns using asterisk (*) notation.
Wildcard MUST only appear at the beginning of the domain name (e.g., *.example.com).

#### Scenario: Match subdomain with wildcard
- GIVEN a policy rule with FQDN "*.example.com"
- WHEN a DNS response for "api.example.com" is received
- THEN the FQDN MUST match the rule
- AND packets to the resolved IP MUST be subject to the policy

#### Scenario: Wildcard does not match parent domain
- GIVEN a policy rule with FQDN "*.example.com"
- WHEN a DNS response for "example.com" is received
- THEN the FQDN MUST NOT match the rule

#### Scenario: Invalid wildcard pattern rejected
- GIVEN a policy rule with FQDN "api.*.com" (wildcard in middle)
- WHEN the policy is validated
- THEN the validation MUST fail
- AND an error MUST be returned
```

### 5. Delta vs Complete Spec

#### ä½•æ—¶ä½¿ç”¨ ADDED

```markdown
## ADDED Requirements

âœ… ä½¿ç”¨åœºæ™¯ï¼šå…¨æ–°çš„åŠŸèƒ½éœ€æ±‚
### Requirement: FQDN Filtering
The system SHALL support domain name based filtering...
```

#### ä½•æ—¶ä½¿ç”¨ MODIFIED

```markdown
## MODIFIED Requirements

âœ… ä½¿ç”¨åœºæ™¯ï¼šä¿®æ”¹ç°æœ‰éœ€æ±‚
### Requirement: Session Tracking
The system SHALL track up to **200k** sessions (previously 100k)...

**Changes from previous version:**
- Capacity: 100k â†’ 200k
- Added per-CPU statistics
- Removed manual cleanup (now LRU auto-eviction)
```

#### ä½•æ—¶ä½¿ç”¨ REMOVED

```markdown
## REMOVED Requirements

âœ… ä½¿ç”¨åœºæ™¯ï¼šåˆ é™¤è¿‡æ—¶éœ€æ±‚
### Requirement: Legacy API v0.x
**Reason**: Replaced by API v1.0
**Migration Guide**: Use /api/v1/* endpoints instead of /v0/*
**Deprecation Timeline**: v0.x removed in version 2.0.0
```

### 6. å½’æ¡£æ—¶æœº

#### ä½•æ—¶å½’æ¡£

```bash
âœ… åº”è¯¥å½’æ¡£ï¼š
- æ‰€æœ‰ä»»åŠ¡å®Œæˆ [x]
- ä»£ç å·²åˆå¹¶åˆ°ä¸»åˆ†æ”¯
- æµ‹è¯•å…¨éƒ¨é€šè¿‡
- æ–‡æ¡£å·²æ›´æ–°

âŒ ä¸åº”å½’æ¡£ï¼š
- ä»»åŠ¡è¿˜æœ‰ [ ] æœªå®Œæˆ
- ä»£ç è¿˜åœ¨ PR é˜¶æ®µ
- æµ‹è¯•å¤±è´¥
- åŠŸèƒ½è¿˜åœ¨å®éªŒä¸­
```

#### å½’æ¡£æ£€æŸ¥æ¸…å•

```markdown
å½’æ¡£å‰æ£€æŸ¥ï¼š
â–¡ tasks.md æ‰€æœ‰ä»»åŠ¡æ ‡è®°ä¸º [x]
â–¡ ä»£ç å·²æäº¤ï¼ˆgit log å¯æŸ¥ï¼‰
â–¡ å•å…ƒæµ‹è¯•é€šè¿‡ï¼ˆè¦†ç›–ç‡ > 80%ï¼‰
â–¡ é›†æˆæµ‹è¯•é€šè¿‡
â–¡ æ€§èƒ½æµ‹è¯•è¾¾æ ‡
â–¡ æ–‡æ¡£å·²æ›´æ–°ï¼ˆAPI docs, README, etc.ï¼‰
â–¡ å˜æ›´å·²åœ¨å›¢é˜Ÿä¼šè®®ä¸Šè¯„å®¡
```

### 7. å›¢é˜Ÿåä½œ

#### ææ¡ˆè¯„å®¡æµç¨‹

```
1. åˆ›å»ºææ¡ˆ
   â†“
2. æäº¤ PRï¼ˆä»… openspec/changes/ ç›®å½•ï¼‰
   â†“
3. å›¢é˜Ÿè¯„å®¡
   - è¯„å®¡ proposal.md: éœ€æ±‚æ˜¯å¦åˆç†ï¼Ÿ
   - è¯„å®¡ design.md: æŠ€æœ¯æ–¹æ¡ˆæ˜¯å¦å¯è¡Œï¼Ÿ
   - è¯„å®¡ tasks.md: ä»»åŠ¡æ˜¯å¦å®Œæ•´ï¼Ÿ
   - è¯„å®¡ spec.md: éœ€æ±‚æ˜¯å¦æ˜ç¡®ï¼Ÿ
   â†“
4. ä¿®æ”¹ææ¡ˆï¼ˆæ ¹æ®åé¦ˆï¼‰
   â†“
5. æ‰¹å‡†ææ¡ˆï¼ˆApprove PRï¼‰
   â†“
6. å¼€å§‹å®æ–½
```

#### å®æ–½è¿›åº¦åŒæ­¥

```bash
# æ¯æ—¥æ›´æ–° tasks.md
- æ—©ä¸Šï¼šè®¡åˆ’ä»Šå¤©å®Œæˆå“ªäº›ä»»åŠ¡
- æ™šä¸Šï¼šæ›´æ–°å®Œæˆçš„ä»»åŠ¡ä¸º [x]

# æ¯å‘¨åŒæ­¥
- å‘¨äº”ï¼šå›¢é˜Ÿä¼šè®®å±•ç¤ºè¿›åº¦
  - è¿è¡Œ: openspec list
  - å±•ç¤º: add-api  18/25 tasks (72% done)

# PR æäº¤ç­–ç•¥
- å°åŠŸèƒ½ï¼šä¸€ä¸ª PR åŒ…å«ä»£ç  + tasks æ›´æ–°
- å¤§åŠŸèƒ½ï¼šåˆ†é˜¶æ®µ PRï¼Œæ¯ä¸ª Phase ä¸€ä¸ª PR
```

#### å¹¶è¡Œå¼€å‘

```bash
# åœºæ™¯ï¼šä¸¤äººåŒæ—¶å¼€å‘ä¸åŒåŠŸèƒ½

å¼€å‘è€… A:
openspec/changes/add-api/
â”œâ”€â”€ proposal.md
â”œâ”€â”€ design.md
â””â”€â”€ tasks.md

å¼€å‘è€… B:
openspec/changes/add-fqdn/
â”œâ”€â”€ proposal.md
â”œâ”€â”€ design.md
â””â”€â”€ tasks.md

# äº’ä¸å†²çªï¼Œç‹¬ç«‹è¿›è¡Œ
# å®Œæˆååˆ†åˆ«å½’æ¡£
```

---

## å¸¸è§é—®é¢˜ï¼ˆFAQï¼‰

### Q1: OpenSpec é€‚åˆä»€ä¹ˆæ ·çš„é¡¹ç›®ï¼Ÿ

**A**: OpenSpec é€‚åˆï¼š

âœ… **é€‚åˆ**ï¼š
- ä¸­å¤§å‹é¡¹ç›®ï¼ˆ10k+ è¡Œä»£ç ï¼‰
- å¤šäººåä½œé¡¹ç›®
- éœ€è¦é•¿æœŸç»´æŠ¤çš„é¡¹ç›®
- åŠŸèƒ½å¤æ‚çš„ç³»ç»Ÿ
- éœ€è¦ä¸¥æ ¼éœ€æ±‚ç®¡ç†çš„é¡¹ç›®

âŒ **ä¸å¤ªé€‚åˆ**ï¼š
- ä¸ªäººç©å…·é¡¹ç›®ï¼ˆè¿‡åº¦å·¥ç¨‹ï¼‰
- ä¸€æ¬¡æ€§è„šæœ¬
- å¿«é€ŸåŸå‹éªŒè¯

### Q2: å¿…é¡»ä½¿ç”¨ OpenSpec CLI å—ï¼Ÿ

**A**: ä¸æ˜¯å¿…é¡»çš„ã€‚

OpenSpec æ ¸å¿ƒæ˜¯**ç›®å½•ç»“æ„å’Œæ–‡æ¡£çº¦å®š**ï¼Œå¯ä»¥ï¼š
- âœ… æ‰‹åŠ¨åˆ›å»ºç›®å½•å’Œæ–‡ä»¶
- âœ… ä½¿ç”¨è‡ªå·±çš„è„šæœ¬
- âœ… é›†æˆåˆ°ç°æœ‰å·¥å…·é“¾

CLI åªæ˜¯è¾…åŠ©å·¥å…·ï¼Œå¸®ä½ è‡ªåŠ¨åŒ–ã€‚

### Q3: èƒ½å¦è·³è¿‡æŸäº›æ–‡ä»¶ï¼Ÿ

**A**: æ ¹æ®é¡¹ç›®è§„æ¨¡çµæ´»è°ƒæ•´ã€‚

**å°åŠŸèƒ½**ï¼ˆ< 1 å‘¨ï¼‰ï¼š
- proposal.mdï¼šå¿…é¡»
- tasks.mdï¼šå¿…é¡»
- design.mdï¼šå¯é€‰
- spec.mdï¼šå¯é€‰

**å¤§åŠŸèƒ½**ï¼ˆ> 1 å‘¨ï¼‰ï¼š
- å…¨éƒ¨æ–‡ä»¶éƒ½å»ºè®®åˆ›å»º

**å…³é”®æ˜¯ä¿æŒä¸€è‡´æ€§**ï¼Œæ•´ä¸ªå›¢é˜Ÿç»Ÿä¸€æ ‡å‡†ã€‚

### Q4: specs/ å’Œ changes/*/specs/ çš„åŒºåˆ«ï¼Ÿ

**A**: è¿™æ˜¯æœ€å®¹æ˜“æ··æ·†çš„åœ°æ–¹ï¼

```
changes/add-api/specs/api/spec.md
â”œâ”€ è¿™æ˜¯å¢é‡ï¼ˆDeltaï¼‰
â”œâ”€ åŒ…å« ADDED/MODIFIED/REMOVED æ ‡è®°
â”œâ”€ æè¿°"è¿™æ¬¡å˜æ›´"è¦æ”¹ä»€ä¹ˆ
â””â”€ å½’æ¡£åä¼šè¢«åˆ é™¤

specs/api/spec.md
â”œâ”€ è¿™æ˜¯å®Œæ•´è§„èŒƒï¼ˆCompleteï¼‰
â”œâ”€ æ²¡æœ‰ ADDED/MODIFIED æ ‡è®°
â”œâ”€ æè¿°"ç³»ç»Ÿå½“å‰"çš„å®Œæ•´åŠŸèƒ½
â””â”€ é€šè¿‡ archive å‘½ä»¤è‡ªåŠ¨ç”Ÿæˆ/æ›´æ–°
```

è®°ä½ï¼š**Delta â†’ Complete çš„è½¬æ¢æ˜¯è‡ªåŠ¨çš„**ã€‚

### Q5: èƒ½å¦ä¿®æ”¹å·²å½’æ¡£çš„æ–‡æ¡£ï¼Ÿ

**A**: å¯ä»¥ï¼Œä½†ä¸æ¨èç›´æ¥ä¿®æ”¹ã€‚

âŒ **ä¸è¦**ï¼šç›´æ¥ä¿®æ”¹ `archive/` ä¸­çš„æ–‡ä»¶ï¼ˆç ´åå†å²è®°å½•ï¼‰

âœ… **åº”è¯¥**ï¼šåˆ›å»ºæ–°çš„å˜æ›´æ¥"ä¿®æ­£"
```bash
/openspec:proposal fix-documentation-for-session-tracking
```

**åŸå› **ï¼šä¿æŒå†å²çš„çœŸå®æ€§å’Œå¯è¿½æº¯æ€§ã€‚

### Q6: å¦‚ä½•å¤„ç†ç´§æ€¥ hotfixï¼Ÿ

**A**: ç´§æ€¥æƒ…å†µå¯ä»¥ç®€åŒ–æµç¨‹ã€‚

```bash
# ç´§æ€¥ä¿®å¤å¯ä»¥è·³è¿‡ proposal é˜¶æ®µ
# ç›´æ¥åˆ›å»º archive æ–‡æ¡£

mkdir -p openspec/changes/archive/2025-10-30-hotfix-memory-leak

cat > openspec/changes/archive/2025-10-30-hotfix-memory-leak/proposal.md <<EOF
# Hotfix: Memory Leak in DNS Parser

## Why
ç”Ÿäº§ç¯å¢ƒå‡ºç°å†…å­˜æ³„æ¼ï¼Œç³»ç»Ÿé‡å¯é¢‘ç‡å¢åŠ 

## What
ä¿®å¤ dns_parser.c ä¸­æœªé‡Šæ”¾çš„å†…å­˜

## Impact
- ä¿®æ”¹ 1 ä¸ªæ–‡ä»¶ï¼Œ10 è¡Œä»£ç 
- æ— åŠŸèƒ½å½±å“
- å†…å­˜å ç”¨æ¢å¤æ­£å¸¸

## Timeline
- ç«‹å³ä¿®å¤å¹¶éƒ¨ç½²
EOF

cat > openspec/changes/archive/2025-10-30-hotfix-memory-leak/tasks.md <<EOF
- [x] å®šä½å†…å­˜æ³„æ¼ç‚¹
- [x] æ·»åŠ å†…å­˜é‡Šæ”¾ä»£ç 
- [x] æœ¬åœ°æµ‹è¯•éªŒè¯
- [x] éƒ¨ç½²åˆ°ç”Ÿäº§
EOF
```

**å…³é”®**ï¼šäº‹åè¡¥å……æ–‡æ¡£ï¼Œä¿æŒè®°å½•å®Œæ•´ã€‚

### Q7: OpenSpec å’Œ Git å¦‚ä½•é…åˆï¼Ÿ

**A**: OpenSpec æ–‡æ¡£å’Œä»£ç ä¸€èµ·ç‰ˆæœ¬ç®¡ç†ã€‚

```bash
# ææ¡ˆé˜¶æ®µï¼šPR åªåŒ…å«æ–‡æ¡£
git add openspec/changes/add-api/
git commit -m "proposal: Add Control Plane API"
git push origin add-api-proposal

# å®æ–½é˜¶æ®µï¼šPR åŒ…å«ä»£ç  + tasks æ›´æ–°
git add src/agent/api/
git add openspec/changes/add-api/tasks.md
git commit -m "feat: Implement health check endpoint (task 4/25)"
git push origin add-api-implementation

# å½’æ¡£é˜¶æ®µï¼šPR åŒ…å«å½’æ¡£æ“ä½œ
openspec archive add-api --yes
git add openspec/changes/archive/
git add openspec/specs/
git commit -m "archive: Add Control Plane API"
git push origin add-api-archive
```

### Q8: å¦‚ä½•åœ¨ç°æœ‰é¡¹ç›®ä¸­å¼•å…¥ OpenSpecï¼Ÿ

**A**: åˆ†æ­¥å¼•å…¥ï¼Œä»æ–°åŠŸèƒ½å¼€å§‹ã€‚

**é˜¶æ®µ 1: å›é¡¾æ€§å½’æ¡£**ï¼ˆå¯é€‰ï¼‰
```bash
# ä¸ºå·²å®ç°çš„æ ¸å¿ƒåŠŸèƒ½è¡¥å……æ–‡æ¡£
# æ”¾å…¥ archive/
```

**é˜¶æ®µ 2: æ–°åŠŸèƒ½ä½¿ç”¨ OpenSpec**
```bash
# ä»ä¸‹ä¸€ä¸ªæ–°åŠŸèƒ½å¼€å§‹
# ä¸¥æ ¼éµå¾ª proposal â†’ apply â†’ archive
```

**é˜¶æ®µ 3: å›¢é˜ŸåŸ¹è®­**
```bash
# åˆ†äº«è¿™ä»½æ–‡æ¡£
# è¿›è¡Œå†…éƒ¨æŠ€æœ¯åˆ†äº«
# ç»Ÿä¸€å›¢é˜Ÿç†è§£
```

**é˜¶æ®µ 4: å®Œå–„è§„èŒƒ**
```bash
# é€æ­¥è¡¥å…… specs/ ç›®å½•
# å½¢æˆå®Œæ•´çš„ç³»ç»Ÿè§„èŒƒ
```

---

## å·¥å…·å’Œé›†æˆ

### ç¼–è¾‘å™¨æ”¯æŒ

#### VS Code

åˆ›å»º `.vscode/settings.json`:

```json
{
  "files.associations": {
    "**/openspec/**/*.md": "markdown"
  },
  "markdown.extension.toc.levels": "2..3",
  "[markdown]": {
    "editor.defaultFormatter": "esbenp.prettier-vscode",
    "editor.wordWrap": "on"
  }
}
```

#### Vim

æ·»åŠ åˆ° `.vimrc`:

```vim
" OpenSpec æ–‡ä»¶è‡ªåŠ¨è¯†åˆ«
autocmd BufNewFile,BufRead */openspec/changes/*/proposal.md setlocal ft=markdown
autocmd BufNewFile,BufRead */openspec/changes/*/design.md setlocal ft=markdown
autocmd BufNewFile,BufRead */openspec/changes/*/tasks.md setlocal ft=markdown

" ä»»åŠ¡å¿«é€Ÿåˆ‡æ¢
function! ToggleCheckbox()
  let line = getline('.')
  if line =~ '^\- \[ \]'
    call setline('.', substitute(line, '^\- \[ \]', '- [x]', ''))
  elseif line =~ '^\- \[x\]'
    call setline('.', substitute(line, '^\- \[x\]', '- [ ]', ''))
  endif
endfunction

nnoremap <leader>x :call ToggleCheckbox()<CR>
```

### Git Hooks

åˆ›å»º `.git/hooks/pre-commit`:

```bash
#!/bin/bash
# æ£€æŸ¥ tasks.md æ ¼å¼

for tasks_file in $(git diff --cached --name-only | grep 'tasks.md$'); do
  echo "Checking $tasks_file..."

  # æ£€æŸ¥ä»»åŠ¡æ ¼å¼
  if ! grep -qE '^- \[(x| )\]' "$tasks_file"; then
    echo "Error: Invalid task format in $tasks_file"
    echo "Tasks must start with '- [ ]' or '- [x]'"
    exit 1
  fi
done

exit 0
```

### CI/CD é›†æˆ

åˆ›å»º `.github/workflows/openspec.yml`:

```yaml
name: OpenSpec Validation

on:
  pull_request:
    paths:
      - 'openspec/changes/**'

jobs:
  validate:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: Install OpenSpec CLI
        run: |
          # å®‰è£… openspec å‘½ä»¤è¡Œå·¥å…·
          curl -L https://github.com/openspec/cli/releases/latest/download/openspec-linux -o /usr/local/bin/openspec
          chmod +x /usr/local/bin/openspec

      - name: Validate Changes
        run: |
          for change_dir in openspec/changes/*; do
            if [ -d "$change_dir" ] && [ "$change_dir" != "openspec/changes/archive" ]; then
              change_id=$(basename "$change_dir")
              echo "Validating $change_id..."
              openspec validate "$change_id" --strict
            fi
          done

      - name: Check Task Progress
        run: |
          openspec list
```

---

## æ€»ç»“

### OpenSpec æ ¸å¿ƒä»·å€¼

1. **ææ¡ˆå…ˆè¡Œ**ï¼šåœ¨å†™ä»£ç å‰æƒ³æ¸…æ¥šè¦åšä»€ä¹ˆ
2. **å˜æ›´å¯è¿½æº¯**ï¼šä»ææ¡ˆåˆ°å®æ–½åˆ°å½’æ¡£ï¼Œå…¨ç¨‹è®°å½•
3. **è§„èŒƒé©±åŠ¨**ï¼šç”¨éœ€æ±‚ï¼ˆRequirementsï¼‰å’Œåœºæ™¯ï¼ˆScenariosï¼‰å®šä¹‰åŠŸèƒ½
4. **çŸ¥è¯†æ²‰æ·€**ï¼šé€šè¿‡ specs/ å’Œ archive/ ä¿ç•™ç³»ç»Ÿæ¼”è¿›å†å²

### ä¸€å›¾æ€»ç»“ OpenSpec

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        OpenSpec å·¥ä½œæµ                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

    PROPOSAL                 APPLY                ARCHIVE
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚ åˆ›å»ºææ¡ˆ â”‚ â”€â”€â”€â”€â”€â”€â”€â”€> â”‚ å®æ–½åŠŸèƒ½ â”‚ â”€â”€â”€â”€â”€â”€> â”‚ å½’æ¡£å˜æ›´ â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚                      â”‚                     â”‚
        â†“                      â†“                     â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ changes/     â”‚      â”‚ changes/     â”‚      â”‚ archive/     â”‚
â”‚ add-api/     â”‚      â”‚ add-api/     â”‚      â”‚ YYYY-MM-DD-  â”‚
â”‚ â”œâ”€proposal.mdâ”‚      â”‚ â”œâ”€tasks.md   â”‚      â”‚ add-api/     â”‚
â”‚ â”œâ”€design.md  â”‚      â”‚ â”‚ [x][x][ ]  â”‚      â”‚              â”‚
â”‚ â”œâ”€tasks.md   â”‚      â”‚ â”‚ è¿›åº¦æ›´æ–°    â”‚      â”‚ specs/       â”‚
â”‚ â””â”€specs/     â”‚      â”‚ â””â”€ç¼–å†™ä»£ç     â”‚      â”‚ add-api/     â”‚
â”‚   (Delta)    â”‚      â”‚              â”‚      â”‚ spec.md      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚ (Complete)   â”‚
                                            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ä¸‰ä¸ªç›®å½•çš„å«ä¹‰                                               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ changes/  = æ­£åœ¨åšä»€ä¹ˆ    (å·¥ä½œåŒº)                          â”‚
â”‚ specs/    = ç³»ç»Ÿæ˜¯ä»€ä¹ˆ    (çœŸç›¸æº)                          â”‚
â”‚ archive/  = åšè¿‡ä»€ä¹ˆ      (å†å²åº“)                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### å¿«é€Ÿå¼€å§‹æ¸…å•

å¯¹äºæƒ³è¦åœ¨å›¢é˜Ÿä¸­å¼•å…¥ OpenSpec çš„ä½ ï¼š

```markdown
â–¡ é˜…è¯»æœ¬æ–‡æ¡£ï¼Œç†è§£æ ¸å¿ƒæ¦‚å¿µ
â–¡ æŸ¥çœ‹é¡¹ç›®ç¤ºä¾‹ï¼ˆå¦‚æœæœ‰ï¼‰
â–¡ ä¸ºä¸‹ä¸€ä¸ªæ–°åŠŸèƒ½åˆ›å»ºç¬¬ä¸€ä¸ªææ¡ˆ
â–¡ å®æ–½åŠŸèƒ½å¹¶æ›´æ–°ä»»åŠ¡æ¸…å•
â–¡ å®Œæˆåæ‰§è¡Œå½’æ¡£
â–¡ åœ¨å›¢é˜Ÿä¼šè®®ä¸Šåˆ†äº«ç»éªŒ
â–¡ é€æ­¥æ¨å¹¿åˆ°æ•´ä¸ªå›¢é˜Ÿ
â–¡ å»ºç«‹å›¢é˜Ÿå†…éƒ¨çš„ OpenSpec æœ€ä½³å®è·µ
```

### å­¦ä¹ èµ„æº

- **å®˜æ–¹æ–‡æ¡£**ï¼šOpenSpec è§„èŒƒè¯´æ˜
- **ç¤ºä¾‹é¡¹ç›®**ï¼šæŸ¥çœ‹ `openspec/changes/archive/` ä¸­çš„çœŸå®æ¡ˆä¾‹
- **æŠ€æœ¯åˆ†äº«**ï¼šæœ¬æ–‡æ¡£é€‚åˆä½œä¸ºæŠ€æœ¯åˆ†äº«ææ–™

---

## é™„å½•

### é™„å½• A: æ–‡æ¡£æ¨¡æ¿

#### proposal.md æ¨¡æ¿

```markdown
# Proposal: [åŠŸèƒ½åç§°]

## Why
[ä¸ºä»€ä¹ˆéœ€è¦è¿™ä¸ªåŠŸèƒ½ï¼Ÿ]
- ä¸šåŠ¡éœ€æ±‚
- æŠ€æœ¯ç—›ç‚¹
- ç”¨æˆ·åé¦ˆ

## What
[è¦åšä»€ä¹ˆï¼Ÿ]
- åŠŸèƒ½ç‚¹ 1
- åŠŸèƒ½ç‚¹ 2
- åŠŸèƒ½ç‚¹ 3

## How
[æ€ä¹ˆåšï¼Ÿç®€è¦æŠ€æœ¯æ–¹æ¡ˆ]
- æŠ€æœ¯é€‰å‹
- æ¶æ„è®¾è®¡
- å®æ–½æ­¥éª¤

## Impact
[å½±å“åˆ†æ]
- ä»£ç å˜æ›´ï¼šæ–°å¢/ä¿®æ”¹å“ªäº›æ¨¡å—
- æ€§èƒ½å½±å“ï¼šCPU/å†…å­˜/å»¶è¿Ÿ
- å…¼å®¹æ€§ï¼šæ˜¯å¦æœ‰ç ´åæ€§å˜æ›´
- é…ç½®å˜æ›´ï¼šæ–°å¢/ä¿®æ”¹é…ç½®é¡¹

## Timeline
[æ—¶é—´è§„åˆ’]
- Week 1: ...
- Week 2: ...
- Week 3: ...

## Risks
[é£é™©å’Œç¼“è§£æªæ–½]
- é£é™© 1ï¼šæè¿° + ç¼“è§£æªæ–½
- é£é™© 2ï¼šæè¿° + ç¼“è§£æªæ–½

## Success Criteria
[æˆåŠŸæ ‡å‡†]
- [ ] åŠŸèƒ½å®Œæ•´æ€§
- [ ] æ€§èƒ½è¾¾æ ‡
- [ ] æµ‹è¯•è¦†ç›–ç‡ > X%
- [ ] æ–‡æ¡£å®Œå–„
```

#### design.md æ¨¡æ¿

```markdown
# Design: [åŠŸèƒ½åç§°]

## Architecture
[æ¶æ„å›¾]

## Components
[ç»„ä»¶è¯´æ˜]

### Component 1
- èŒè´£
- æ¥å£
- ä¾èµ–

### Component 2
...

## Data Structures
[æ•°æ®ç»“æ„å®šä¹‰]

## Algorithms
[æ ¸å¿ƒç®—æ³•]

## API Design
[API è®¾è®¡]

## Technical Decisions
[æŠ€æœ¯å†³ç­–]

### Decision 1: [å†³ç­–æ ‡é¢˜]
- **é€‰æ‹©**ï¼šæ–¹æ¡ˆ A
- **åŸå› **ï¼š...
- **å¤‡é€‰**ï¼šæ–¹æ¡ˆ B, C
- **æƒè¡¡**ï¼š...

## Performance Considerations
[æ€§èƒ½è€ƒè™‘]

## Security Considerations
[å®‰å…¨è€ƒè™‘]

## Testing Strategy
[æµ‹è¯•ç­–ç•¥]
```

#### tasks.md æ¨¡æ¿

```markdown
# Tasks: [åŠŸèƒ½åç§°]

## Phase 1: [é˜¶æ®µåç§°]
- [ ] ä»»åŠ¡ 1
- [ ] ä»»åŠ¡ 2
- [ ] ä»»åŠ¡ 3

## Phase 2: [é˜¶æ®µåç§°]
- [ ] ä»»åŠ¡ 4
- [ ] ä»»åŠ¡ 5

## Phase 3: Testing
- [ ] Unit tests
- [ ] Integration tests
- [ ] Performance tests

## Phase 4: Documentation
- [ ] API documentation
- [ ] User guide
- [ ] Migration guide (if needed)
```

#### spec.md æ¨¡æ¿

```markdown
# Capability: [åŠŸèƒ½åç§°]

## ADDED Requirements

### Requirement: [éœ€æ±‚æ ‡é¢˜]
[è¯¦ç»†æè¿°ï¼Œä½¿ç”¨ SHALL/MUST/SHOULD]

#### Scenario: [åœºæ™¯åç§°]
- GIVEN [å‰ç½®æ¡ä»¶]
- WHEN [è§¦å‘åŠ¨ä½œ]
- THEN [é¢„æœŸç»“æœ]
- AND [é¢å¤–éªŒè¯]

#### Scenario: [å¦ä¸€ä¸ªåœºæ™¯]
...

### Requirement: [å¦ä¸€ä¸ªéœ€æ±‚]
...

## MODIFIED Requirements
[å¦‚æœæ˜¯ä¿®æ”¹ç°æœ‰åŠŸèƒ½]

### Requirement: [åŸæœ‰éœ€æ±‚æ ‡é¢˜]
[ä¿®æ”¹åçš„å®Œæ•´æè¿°]

**Changes from previous version:**
- å˜æ›´ç‚¹ 1
- å˜æ›´ç‚¹ 2

## REMOVED Requirements
[å¦‚æœåˆ é™¤åŠŸèƒ½]

### Requirement: [è¢«åˆ é™¤çš„éœ€æ±‚]
**Reason**: [åˆ é™¤åŸå› ]
**Migration**: [è¿ç§»æŒ‡å—]
```

### é™„å½• B: å‘½ä»¤é€ŸæŸ¥è¡¨

```bash
# === åˆ›å»ºå’Œç®¡ç†å˜æ›´ ===
/openspec:proposal <change-id>          # åˆ›å»ºææ¡ˆ
/openspec:apply <change-id>             # å¼€å§‹å®æ–½
/openspec:archive <change-id>           # å½’æ¡£å˜æ›´

# === æŸ¥çœ‹çŠ¶æ€ ===
openspec list                           # æ´»åŠ¨å˜æ›´åˆ—è¡¨
openspec list --specs                   # å®Œæ•´è§„èŒƒåˆ—è¡¨
openspec validate <change-id> --strict  # éªŒè¯ææ¡ˆ

# === æ‰‹åŠ¨æ“ä½œ ===
mkdir -p openspec/changes/<change-id>/specs
cat openspec/changes/<change-id>/tasks.md
ls -la openspec/changes/archive/
ls -la openspec/specs/

# === ä»»åŠ¡è¿›åº¦ ===
grep -c '^\- \[x\]' tasks.md            # å·²å®Œæˆä»»åŠ¡æ•°
grep -c '^\- \[' tasks.md               # æ€»ä»»åŠ¡æ•°
```

### é™„å½• C: æ£€æŸ¥æ¸…å•

#### ææ¡ˆè¯„å®¡æ£€æŸ¥æ¸…å•

```markdown
â–¡ proposal.md åŒ…å« Why/What/Impact
â–¡ design.md åŒ…å«æŠ€æœ¯æ–¹æ¡ˆå’Œæ¶æ„å›¾
â–¡ tasks.md ä»»åŠ¡ç²’åº¦é€‚ä¸­ï¼ˆ1-4 å°æ—¶/ä»»åŠ¡ï¼‰
â–¡ spec.md ä½¿ç”¨æ­£ç¡®çš„ ADDED/MODIFIED/REMOVED æ ‡è®°
â–¡ æ‰€æœ‰ Requirement éƒ½æœ‰è‡³å°‘ 2 ä¸ª Scenario
â–¡ æ€§èƒ½ç›®æ ‡æ˜ç¡®ä¸”å¯æµ‹é‡
â–¡ é£é™©å’Œç¼“è§£æªæ–½å·²è¯†åˆ«
â–¡ æ—¶é—´ä¼°ç®—åˆç†
```

#### å½’æ¡£å‰æ£€æŸ¥æ¸…å•

```markdown
â–¡ tasks.md æ‰€æœ‰ä»»åŠ¡æ ‡è®°ä¸º [x]
â–¡ ä»£ç å·²åˆå¹¶åˆ°ä¸»åˆ†æ”¯
â–¡ å•å…ƒæµ‹è¯•é€šè¿‡ï¼ˆè¦†ç›–ç‡ > 80%ï¼‰
â–¡ é›†æˆæµ‹è¯•é€šè¿‡
â–¡ æ€§èƒ½æµ‹è¯•è¾¾æ ‡
â–¡ API æ–‡æ¡£å·²æ›´æ–°
â–¡ README å·²æ›´æ–°ï¼ˆå¦‚æœ‰å¿…è¦ï¼‰
â–¡ å˜æ›´å·²åœ¨å›¢é˜Ÿè¯„å®¡
```

---

**æ–‡æ¡£ç‰ˆæœ¬**: 1.0
**æœ€åæ›´æ–°**: 2025-10-31
**ä½œè€…**: eBPF å¾®éš”ç¦»é¡¹ç›®ç»„
**é€‚ç”¨äº**: OpenSpec å­¦ä¹ å’ŒæŠ€æœ¯åˆ†äº«

---

**END**